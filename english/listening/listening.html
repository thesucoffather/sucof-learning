<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HTML Listening</title>
    <link rel="stylesheet" href="./style.css" />
</head>

<body>
    <main class="page">
        <section class="card">
            <header class="header">
                <h1 class="title">Listening</h1>
                <!--  <p class="subtitle">Ch·ªçn gi·ªçng ƒë·ªçc, ch·ªçn ch·ªß ƒë·ªÅ, nghe v√† ƒëi·ªÅn t·ª´</p> -->
            </header>

            <!-- Controls -->
            <div class="panel">
                <div class="row">
                    <div class="field">
                        <div class="label">Gi·ªçng ƒë·ªçc</div>
                        <div class="seg">
                            <label class="seg-item">
                                <input type="radio" name="voice" value="male" checked />
                                <span>Nam</span>
                            </label>
                            <label class="seg-item">
                                <input type="radio" name="voice" value="female" />
                                <span>N·ªØ</span>
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">Category</div>
                        <select id="categorySelect" class="select" disabled>
                            <option value="__loading__">ƒêang t·∫£i...</option>
                        </select>
                    </div>
                </div>

                <div class="row row-tight">
                    <label class="check">
                        <input id="autoListen" type="checkbox" checked />
                        <span>T·ª± ph√°t audio</span>
                    </label>

                    <button id="btnPlay" class="btn btn-secondary" type="button" disabled>
                        üîä Ph√°t √¢m
                    </button>
                </div>
            </div>

            <!-- Question -->
            <div class="question">
                <div class="q-top">
                    <div class="q-badge" id="qBadge">C√¢u: 0/0</div>
                    <div class="q-vn" id="vnText">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>

                <textarea id="answerInput" class="textarea" rows="2"
                    placeholder="B√© g√µ t·ª´ ti·∫øng Anh v√†o ƒë√¢y (c√≥ th·ªÉ g√µ d√†i h∆°n m·ªôt ch√∫t)‚Ä¶" disabled></textarea>

                <div class="actions">
                    <button id="btnSubmit" class="btn btn-primary" type="button" disabled>
                        ‚úÖ Submit (N·ªôp b√†i)
                    </button>
                    <button id="btnNext" class="btn btn-ghost" type="button" disabled>
                        ‚è≠ Next (C√¢u ti·∫øp theo)
                    </button>
                </div>

                <div id="feedback" class="feedback" aria-live="polite"></div>

                <!-- Stats -->
                <div class="stats">
                    <div class="stat">
                        <div class="stat-k">S·ªë c√¢u h·ªèi</div>
                        <div class="stat-v" id="statTotalQ">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-k">ƒê√∫ng</div>
                        <div class="stat-v" id="statCorrect">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-k">T·ªïng submit</div>
                        <div class="stat-v" id="statTotalSubmit">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-k">T·ª∑ l·ªá ƒë√∫ng</div>
                        <div class="stat-v" id="statAcc">0%</div>
                    </div>
                </div>
            </div>

            <audio id="player" preload="auto"></audio>

            <footer class="footer">
                <small class="hint">
                    D·ªØ li·ªáu: <code>../assets/vocabulary/vocabulary.csv</code> ‚Ä¢ Audio: <code>../assets/audio/male</code>
                    / <code>../assets/audio/female</code>
                </small>
            </footer>
        </section>
    </main>

    <script>
        // ====== Paths (theo y√™u c·∫ßu c·ªßa b·∫°n) ======
        const CSV_PATH = "../../assets/vocabulary/vocabulary.csv";
        const AUDIO_BASE = {
            male: "../../assets/audio/male",
            female: "../../assets/audio/female",
        };

        // ====== State ======
        let rows = [];              // to√†n b·ªô t·ª´ v·ª±ng
        let currentList = [];       // danh s√°ch c√¢u h·ªèi ƒëang ch·∫°y (ƒë√£ random)
        let idx = 0;                // c√¢u hi·ªán t·∫°i (index trong currentList)
        let totalQuestions = 0;     // t·ªïng c√¢u theo rule (category: full, all: 20)
        let correctCount = 0;       // s·ªë l·∫ßn submit ƒë√∫ng
        let totalSubmit = 0;        // t·ªïng s·ªë l·∫ßn submit
        let selectedCategory = "__all__";
        let voice = "male";

        // ====== Elements ======
        const elCategory = document.getElementById("categorySelect");
        const elAutoListen = document.getElementById("autoListen");
        const elBtnPlay = document.getElementById("btnPlay");
        const elBtnSubmit = document.getElementById("btnSubmit");
        const elBtnNext = document.getElementById("btnNext");
        const elInput = document.getElementById("answerInput");
        const elFeedback = document.getElementById("feedback");
        const elVN = document.getElementById("vnText");
        const elBadge = document.getElementById("qBadge");
        const player = document.getElementById("player");

        const elStatTotalQ = document.getElementById("statTotalQ");
        const elStatCorrect = document.getElementById("statCorrect");
        const elStatTotalSubmit = document.getElementById("statTotalSubmit");
        const elStatAcc = document.getElementById("statAcc");

        // ====== Helpers ======
        function normalizeAnswer(s) {
            return (s || "")
                .trim()
                .toLowerCase()
                .replace(/\s+/g, " ");
        }

        function setFeedback(type, text) {
            elFeedback.className = "feedback " + (type ? ("fb-" + type) : "");
            elFeedback.textContent = text || "";
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // CSV parser (ƒë·ªß d√πng cho d·∫•u ph·∫©y + d·∫•u ngo·∫∑c k√©p)
        function parseCSV(text) {
            const out = [];
            let row = [];
            let cur = "";
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                const next = text[i + 1];

                if (ch === '"') {
                    if (inQuotes && next === '"') { // escaped quote
                        cur += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                    continue;
                }

                if (!inQuotes && ch === ",") {
                    row.push(cur);
                    cur = "";
                    continue;
                }

                if (!inQuotes && (ch === "\n" || ch === "\r")) {
                    if (ch === "\r" && next === "\n") i++;
                    row.push(cur);
                    cur = "";
                    // b·ªè d√≤ng r·ªóng
                    if (row.some(v => String(v).trim() !== "")) out.push(row);
                    row = [];
                    continue;
                }

                cur += ch;
            }

            // last cell
            row.push(cur);
            if (row.some(v => String(v).trim() !== "")) out.push(row);
            return out;
        }

        function rowsFromCSV(csvText) {
            const table = parseCSV(csvText);
            if (!table.length) return [];

            const header = table[0].map(h => String(h).trim().toLowerCase());
            const idxCategory = header.indexOf("category");
            const idxEn = header.indexOf("english");
            const idxVi = header.indexOf("vietnamese");
            const idxAF = header.indexOf("audio-f");
            const idxAM = header.indexOf("audio-m");

            // N·∫øu thi·∫øu c·ªôt b·∫Øt bu·ªôc, b√°o l·ªói r√µ r√†ng (kh√¥ng ƒëo√°n)
            const required = { category: idxCategory, english: idxEn, vietnamese: idxVi, "audio-f": idxAF, "audio-m": idxAM };
            const missing = Object.entries(required).filter(([, v]) => v === -1).map(([k]) => k);
            if (missing.length) {
                throw new Error("Thi·∫øu c·ªôt trong vocabulary.csv: " + missing.join(", "));
            }

            const data = [];
            for (let r = 1; r < table.length; r++) {
                const line = table[r];
                const obj = {
                    category: (line[idxCategory] ?? "").trim(),
                    english: (line[idxEn] ?? "").trim(),
                    vietnamese: (line[idxVi] ?? "").trim(),
                    audioF: (line[idxAF] ?? "").trim(),
                    audioM: (line[idxAM] ?? "").trim(),
                };
                if (obj.english) data.push(obj);
            }
            return data;
        }

        function getAudioFileForRow(row) {
            const rawName = (voice === "male") ? row.audioM : row.audioF;
            if (!rawName) return null;
            const base = AUDIO_BASE[voice];
            // th√™m .mp3 n·∫øu CSV kh√¥ng c√≥ extension
            const fileName = rawName.endsWith(".mp3") ? rawName : rawName + ".mp3";
            // ch·ªâ encode kho·∫£ng tr·∫Øng
            let safeName = fileName.replaceAll(" ", "%20");
            safeName = safeName.toLowerCase();
            return base + "/" + safeName;
        }

        function updateStatsUI() {
            elStatTotalQ.textContent = String(totalQuestions);
            elStatCorrect.textContent = String(correctCount);
            elStatTotalSubmit.textContent = String(totalSubmit);

            const acc = totalSubmit === 0 ? 0 : (correctCount / totalSubmit) * 100;
            elStatAcc.textContent = acc.toFixed(0) + "%";
        }

        function updateQuestionUI() {
            if (!currentList.length || idx >= currentList.length) return;

            const row = currentList[idx];
            elVN.textContent = "H√£y ƒëi·ªÅn c√¢u tr·∫£ l·ªùi"; <!--row.vietnamese || "(Kh√¥ng c√≥ nghƒ©a ti·∫øng Vi·ªát)";-->
            elBadge.textContent = `C√¢u: ${Math.min(idx + 1, totalQuestions)}/${totalQuestions}`;

            const audioSrc = getAudioFileForRow(row);
            elBtnPlay.disabled = !audioSrc;
            player.src = audioSrc || "";
            player.load();

            elInput.value = "";
            elInput.focus();

            setFeedback("", "");
            updateStatsUI();

            if (elAutoListen.checked && audioSrc) {
                // c·ªë g·∫Øng autoplay; n·∫øu tr√¨nh duy·ªát ch·∫∑n th√¨ b√© b·∫•m "Nghe l·∫°i"
                player.play().catch(() => { });
            }
        }

        function finishUI() {
            elVN.textContent = "üéâ Ho√†n th√†nh!";
            elBadge.textContent = `C√¢u: ${totalQuestions}/${totalQuestions}`;
            elBtnPlay.disabled = true;
            elBtnSubmit.disabled = true;
            elBtnNext.disabled = true;
            elInput.disabled = true;

            setFeedback("ok", `B√© ƒë√£ l√†m xong. ƒê√∫ng ${correctCount}/${totalSubmit} l·∫ßn submit.`);
            updateStatsUI();
        }

        function buildQuizList() {
            // l·ªçc theo category
            let list = [];
            if (selectedCategory === "__all__") {
                list = rows.slice();
                list = shuffle(list).slice(0, Math.min(20, list.length)); // all -> 20 t·ª´
            } else {
                list = rows.filter(r => r.category === selectedCategory);
                list = shuffle(list); // category -> random to√†n b·ªô trong category
            }

            currentList = list;
            idx = 0;
            totalQuestions = currentList.length;

            // reset stats
            correctCount = 0;
            totalSubmit = 0;
            updateStatsUI();

            elBtnSubmit.disabled = totalQuestions === 0;
            elBtnNext.disabled = totalQuestions === 0;
            elInput.disabled = totalQuestions === 0;

            if (totalQuestions === 0) {
                setFeedback("bad", "Kh√¥ng c√≥ d·ªØ li·ªáu cho l·ª±a ch·ªçn n√†y.");
                elVN.textContent = "Kh√¥ng c√≥ c√¢u h·ªèi.";
                elBadge.textContent = "C√¢u: 0/0";
                elBtnPlay.disabled = true;
                return;
            }

            updateQuestionUI();
        }

        // ====== Actions ======
        function onSubmit() {
            if (!currentList.length || idx >= currentList.length) return;

            const row = currentList[idx];
            const expected = normalizeAnswer(row.english);
            const got = normalizeAnswer(elInput.value);

            if (!got) {
                setFeedback("warn", "B√© ch∆∞a nh·∫≠p ƒë√°p √°n.");
                elInput.focus();
                return;
            }

            totalSubmit += 1;

            if (got === expected) {
                correctCount += 1;
                setFeedback("ok", "‚úÖ ƒê√∫ng r·ªìi! Chuy·ªÉn sang c√¢u ti·∫øp theo‚Ä¶");
                updateStatsUI();

                // chuy·ªÉn c√¢u
                idx += 1;
                if (idx >= totalQuestions) {
                    finishUI();
                } else {
                    updateQuestionUI();
                }
            } else {
                // sai: b√°o ƒë·ªè + clear input, KH√îNG chuy·ªÉn c√¢u
                setFeedback("bad", "‚ùå Sai r·ªìi. B√© th·ª≠ l·∫°i nh√©!");
                updateStatsUI();
                elInput.value = "";
                elInput.focus();
            }
        }

        function onNext() {
            if (!currentList.length) return;
            idx += 1;
            if (idx >= totalQuestions) {
                finishUI();
            } else {
                updateQuestionUI();
            }
        }

        function onPlay() {
            if (!player.src) return;
            player.play().catch(() => { });
        }

        function onVoiceChange(newVoice) {
            voice = newVoice;
            // ƒë·ªïi gi·ªçng th√¨ gi·ªØ nguy√™n c√¢u hi·ªán t·∫°i, ch·ªâ ƒë·ªïi audio
            if (currentList.length && idx < currentList.length) {
                const audioSrc = getAudioFileForRow(currentList[idx]);
                elBtnPlay.disabled = !audioSrc;
                player.src = audioSrc || "";
                player.load();
                if (elAutoListen.checked && audioSrc) {
                    player.play().catch(() => { });
                }
            }
        }

        function onCategoryChange(val) {
            selectedCategory = val;
            buildQuizList();
        }

        // ====== Init ======
        async function init() {
            try {
                const res = await fetch(CSV_PATH, { cache: "no-store" });
                if (!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c vocabulary.csv (HTTP " + res.status + ")");
                const csvText = await res.text();

                rows = rowsFromCSV(csvText);

                // categories
                const categories = Array.from(new Set(rows.map(r => r.category).filter(Boolean))).sort((a, b) => a.localeCompare(b));
                elCategory.innerHTML = "";
                const optAll = document.createElement("option");
                optAll.value = "__all__";
                optAll.textContent = "All (20 c√¢u)";
                elCategory.appendChild(optAll);

                for (const c of categories) {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    elCategory.appendChild(opt);
                }

                elCategory.disabled = false;

                // enable UI
                elBtnPlay.disabled = true;
                elBtnSubmit.disabled = false;
                elBtnNext.disabled = false;
                elInput.disabled = false;

                // build first quiz
                selectedCategory = "__all__";
                buildQuizList();

                setFeedback("", "");
            } catch (err) {
                elCategory.disabled = true;
                elBtnPlay.disabled = true;
                elBtnSubmit.disabled = true;
                elBtnNext.disabled = true;
                elInput.disabled = true;

                elVN.textContent = "L·ªói t·∫£i d·ªØ li·ªáu.";
                elBadge.textContent = "C√¢u: 0/0";
                setFeedback("bad", String(err && err.message ? err.message : err));
            }
        }

        // events
        document.querySelectorAll('input[name="voice"]').forEach(radio => {
            radio.addEventListener("change", (e) => onVoiceChange(e.target.value));
        });

        elCategory.addEventListener("change", (e) => onCategoryChange(e.target.value));
        elBtnPlay.addEventListener("click", onPlay);
        elBtnSubmit.addEventListener("click", onSubmit);
        elBtnNext.addEventListener("click", onNext);

        elInput.addEventListener("keydown", (e) => {
            // Ctrl+Enter ho·∫∑c Cmd+Enter ƒë·ªÉ submit nhanh
            if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
                e.preventDefault();
                onSubmit();
            }
        });

        init();
    </script>
</body>

</html>