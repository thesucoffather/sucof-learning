<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sucof Learning - Vocabulary</title>
    <link rel="stylesheet" href="quiz.css" />
</head>

<body>
    <main class="page">
        <section class="card">
            <header class="header">
                <h1 class="title">Vocabulary</h1>
                <!-- <p class="subtitle">Ch·ªçn danh m·ª•c v√† b·∫Øt ƒë·∫ßu l√†m b√†i</p> -->
            </header>

            <div class="controls">
                <div class="control">
                    <label class="label" for="categorySelect">Ch·ªçn Category v√† b·∫Øt ƒë·∫ßu</label>
                    <select id="categorySelect" class="select" disabled>
                        <option value="__loading__">ƒêang t·∫£i...</option>
                    </select>
                </div>

                <div class="toggles">
                    <label class="toggle">
                        <input id="toggleImage" type="checkbox" checked />
                        <span>Hi·ªÉn th·ªã h√¨nh ·∫£nh</span>
                    </label>

                    <label class="toggle">
                        <input id="toggleVn" type="checkbox" checked />
                        <span>Hi·ªÉn th·ªã ti·∫øng Vi·ªát</span>
                    </label>
                </div>

                <div class="actions">
                    <button id="startBtn" class="btn btn-primary" disabled>B·∫Øt ƒë·∫ßu</button>
                    <button id="resetBtn" class="btn btn-ghost" disabled>L√†m l·∫°i</button>
                </div>
            </div>

            <hr class="divider" />

            <div id="quizArea" class="quiz hidden">

                <div class="prompt">
                    <div id="imgWrap" class="img-wrap">
                        <img id="questionImg" class="question-img" alt="" />
                    </div>

                    <div id="vnText" class="vn hidden"></div>
                    <!-- <div id="helper" class="helper">H√£y g√µ t·ª´ ti·∫øng Anh v√†o √¥ b√™n d∆∞·ªõi</div> -->
                </div>

                <div class="answer">
                    <input id="answerInput" class="input" type="text" inputmode="text" autocomplete="off"
                        spellcheck="false" placeholder="B√© g√µ t·ª´ ti·∫øng Anh ·ªü ƒë√¢y..." disabled />
                    <div class="btn-row">
                        <button id="submitBtn" class="btn btn-success" disabled>Submit</button>
                        <button id="nextBtn" class="btn btn-secondary" disabled>Next</button>
                    </div>

                    <div id="feedback" class="feedback" aria-live="polite"></div>
                </div>

                <div class="stats">
                    <div class="pill"><span class="pill-label">C√¢u h·ªèi:</span> <span id="statQ">0/0</span></div>
                    <div class="pill"><span class="pill-label">ƒê√∫ng:</span> <span id="statCorrect">0</span></div>
                    <div class="pill"><span class="pill-label">T·ªïng submit:</span> <span id="statSubmit">0</span></div>
                    <div class="pill"><span class="pill-label">T·ª∑ l·ªá ƒë√∫ng:</span> <span id="statRate">0%</span></div>
                </div>
            </div>

            <div id="doneArea" class="done hidden">
                <div class="done-title">Ho√†n th√†nh üéâ</div>
                <div class="done-sub">B√© l√†m r·∫•t t·ªët!</div>
                <!-- <button id="doneResetBtn" class="btn btn-primary">L√†m l·∫°i</button> -->
            </div>
        </section>
    </main>

    <script>
        // ====== CONFIG PATHS ======
        const CSV_PATH = "../../assets/vocabulary/vocabulary.csv";
        const PICTURES_DIR = "../../assets/pictures/"; // file name = english (lower case, c√≥ kho·∫£ng tr·∫Øng) + ".jpg"

        // ====== STATE ======
        let rows = [];             // all csv rows
        let categories = [];       // unique category list
        let queue = [];            // selected questions, shuffled
        let idx = 0;               // current question index
        let correctCount = 0;      // number of correct submits
        let submitCount = 0;       // total submits
        let started = false;

        // ====== ELEMENTS ======
        const categorySelect = document.getElementById("categorySelect");
        const toggleImage = document.getElementById("toggleImage");
        const toggleVn = document.getElementById("toggleVn");

        const startBtn = document.getElementById("startBtn");
        const resetBtn = document.getElementById("resetBtn");

        const quizArea = document.getElementById("quizArea");
        const doneArea = document.getElementById("doneArea");
        //const doneResetBtn = document.getElementById("doneResetBtn");

        const imgWrap = document.getElementById("imgWrap");
        const questionImg = document.getElementById("questionImg");
        const vnText = document.getElementById("vnText");
        const helper = document.getElementById("helper");

        const answerInput = document.getElementById("answerInput");
        const submitBtn = document.getElementById("submitBtn");
        const nextBtn = document.getElementById("nextBtn");
        const feedback = document.getElementById("feedback");

        const statQ = document.getElementById("statQ");
        const statCorrect = document.getElementById("statCorrect");
        const statSubmit = document.getElementById("statSubmit");
        const statRate = document.getElementById("statRate");

        // ====== CSV PARSER (handles quotes + commas) ======
        function parseCSV(text) {
            const out = [];
            let row = [];
            let cur = "";
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                const next = text[i + 1];

                if (ch === '"') {
                    if (inQuotes && next === '"') { // escaped quote
                        cur += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                    continue;
                }

                if (!inQuotes && ch === ",") {
                    row.push(cur);
                    cur = "";
                    continue;
                }

                if (!inQuotes && (ch === "\n")) {
                    row.push(cur);
                    cur = "";
                    // ignore empty last line
                    if (row.some(cell => cell.trim() !== "")) out.push(row);
                    row = [];
                    continue;
                }

                if (ch === "\r") continue; // windows line endings
                cur += ch;
            }

            // last cell
            row.push(cur);
            if (row.some(cell => cell.trim() !== "")) out.push(row);
            return out;
        }

        function normalizeAnswer(s) {
            return (s ?? "").trim().toLowerCase();
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function setFeedback(msg, type) {
            feedback.textContent = msg || "";
            feedback.className = "feedback";
            if (type === "ok") feedback.classList.add("ok");
            if (type === "bad") feedback.classList.add("bad");
        }

        function updateStats() {
            statQ.textContent = `${Math.min(idx + 1, queue.length)}/${queue.length}`;
            statCorrect.textContent = String(correctCount);
            statSubmit.textContent = String(submitCount);
            const rate = submitCount === 0 ? 0 : Math.round((correctCount / submitCount) * 100);
            statRate.textContent = `${rate}%`;
        }

        function showDone() {
            started = false;

            // disable thao t√°c
            answerInput.disabled = true;
            submitBtn.disabled = true;
            nextBtn.disabled = true;

            // ·∫©n ph·∫ßn c√¢u h·ªèi (·∫£nh + input)
            document.querySelector(".prompt").classList.add("hidden");
            document.querySelector(".answer").classList.add("hidden");

            // HI·ªÜN th√¥ng b√°o ho√†n th√†nh
            doneArea.classList.remove("hidden");

            resetBtn.disabled = false;
        }

        function currentItem() {
            return queue[idx];
        }

        function imagePathFromEnglish(english) {
            // y√™u c·∫ßu: filename = English (c√≥ kho·∫£ng tr·∫Øng, lower case) + ".jpg"
            const name = (english ?? "").toLowerCase();
            return PICTURES_DIR + name + ".jpg";
        }

        function renderQuestion() {
            setFeedback("", null);
            if (!queue.length) return;

            const item = currentItem();
            const showImg = toggleImage.checked;
            const showVN = toggleVn.checked;

            // X·ª≠ l√Ω h√¨nh ·∫£nh
            if (showImg) {
                // 1. Hi·ªán wrap tr∆∞·ªõc
                imgWrap.classList.remove("hidden");
                imgWrap.innerHTML = ""; // X√≥a ·∫£nh c≈©

                const img = document.createElement("img");
                img.className = "question-img";

                // 2. T·∫°o ƒë∆∞·ªùng d·∫´n
                const src = imagePathFromEnglish(item.english);

                // 3. G√°n src v√† ch√®n v√†o DOM
                img.src = src;
                imgWrap.appendChild(img);

                img.onerror = () => {
                    imgWrap.classList.add("hidden");
                };
            } else {
                // N·∫øu kh√¥ng t√≠ch ch·ªçn h√¨nh ·∫£nh th√¨ ·∫©n ƒëi
                imgWrap.classList.add("hidden");
            }

            // X·ª≠ l√Ω ti·∫øng Vi·ªát
            if (showVN) {
                vnText.classList.remove("hidden");
                vnText.textContent = item.vietnamese || "";
            } else {
                vnText.classList.add("hidden");
            }

            answerInput.value = "";
            answerInput.focus();
            updateStats();
        }

        function nextQuestion() {
            if (!queue.length) return;

            idx++;
            if (idx >= queue.length) {
                showDone();
                return;
            }
            renderQuestion();
        }

        function buildQueue() {
            const selected = categorySelect.value;

            let filtered;
            if (selected === "__all__") {
                filtered = rows.slice();
                shuffle(filtered);
                filtered = filtered.slice(0, Math.min(20, filtered.length)); // all -> 20 c√¢u
            } else {
                filtered = rows.filter(r => r.category === selected);
                shuffle(filtered); // category -> random to√†n b·ªô
            }

            return filtered;
        }

        function startQuiz() {
            console.log("ƒêang b·∫Øt ƒë·∫ßu b√†i h·ªçc...");
            queue = buildQueue();
            idx = 0;
            correctCount = 0;
            submitCount = 0;

            setFeedback("", null);
            updateStats();

            // 1. Reset giao di·ªán ch√≠nh
            doneArea.classList.add("hidden");
            quizArea.classList.remove("hidden");

            // QUAN TR·ªåNG: Hi·ªán l·∫°i ph·∫ßn c√¢u h·ªèi v√† √¥ nh·∫≠p li·ªáu (v√¨ b·ªã ·∫©n ·ªü showDone)
            document.querySelector(".prompt").classList.remove("hidden");
            document.querySelector(".answer").classList.remove("hidden");

            started = true;
            answerInput.disabled = false;
            submitBtn.disabled = false;
            nextBtn.disabled = false;
            resetBtn.disabled = false;

            if (queue.length === 0) {
                setFeedback("Kh√¥ng c√≥ t·ª´ n√†o trong l·ª±a ch·ªçn n√†y.", "bad");
                showDone();
                return;
            }

            // ƒê·∫£m b·∫£o UI c·∫≠p nh·∫≠t xong r·ªìi m·ªõi v·∫Ω c√¢u h·ªèi
            window.requestAnimationFrame(() => {
                renderQuestion();
            });
        }
        function resetAll() {
            queue = [];
            idx = 0;
            correctCount = 0;
            submitCount = 0;
            started = false;

            quizArea.classList.add("hidden");
            doneArea.classList.add("hidden");

            // Hi·ªán l·∫°i s·∫µn c√°c ph·∫ßn n√†y ƒë·ªÉ l·∫ßn sau Start kh√¥ng b·ªã m·∫•t
            document.querySelector(".prompt").classList.remove("hidden");
            document.querySelector(".answer").classList.remove("hidden");

            answerInput.value = "";
            answerInput.disabled = true;
            submitBtn.disabled = true;
            nextBtn.disabled = true;

            setFeedback("", null);
            updateStats();
        }

        function handleSubmit() {
            if (!started || !queue.length) return;

            const item = currentItem();
            const typed = normalizeAnswer(answerInput.value);
            const target = normalizeAnswer(item.english);

            if (!typed) {
                setFeedback("B√© ch∆∞a nh·∫≠p ƒë√°p √°n.", "bad");
                answerInput.value = "";
                answerInput.focus();
                return;
            }

            submitCount++;

            if (typed === target) {
                correctCount++;
                updateStats();
                setFeedback("ƒê√∫ng r·ªìi ‚úÖ", "ok");
                // chuy·ªÉn c√¢u sau 1 nh·ªãp ng·∫Øn ƒë·ªÉ b√© nh√¨n th·∫•y
                setTimeout(() => {
                    answerInput.value = "";
                    nextQuestion();
                }, 350);
            } else {
                updateStats();
                setFeedback("Sai r·ªìi ‚ùå (th·ª≠ l·∫°i nh√©)", "bad");
                answerInput.value = "";
                answerInput.focus();
            }
        }

        // ====== LOAD CSV ======
        async function loadData() {
            try {
                const res = await fetch(CSV_PATH, { cache: "no-store" });
                if (!res.ok) throw new Error("Fetch failed: " + res.status);
                const text = await res.text();

                const table = parseCSV(text);
                if (table.length < 2) throw new Error("CSV empty or missing header");

                const header = table[0].map(h => (h ?? "").trim().toLowerCase());
                const idxCategory = header.indexOf("category");
                const idxEnglish = header.indexOf("english");
                const idxVn = header.indexOf("vietnamese");

                // audio columns exist but not required for this UI
                if (idxCategory === -1 || idxEnglish === -1 || idxVn === -1) {
                    throw new Error("CSV must have columns: category, english, vietnamese");
                }

                rows = table.slice(1).map(r => ({
                    category: (r[idxCategory] ?? "").trim(),
                    english: (r[idxEnglish] ?? "").trim(),
                    vietnamese: (r[idxVn] ?? "").trim(),
                }))
                    .filter(r => r.english && r.category); // basic sanity

                const set = new Set(rows.map(r => r.category));
                categories = Array.from(set).sort((a, b) => a.localeCompare(b, "vi"));

                // Populate select
                categorySelect.innerHTML = "";
                const optAll = document.createElement("option");
                optAll.value = "__all__";
                optAll.textContent = "All";
                categorySelect.appendChild(optAll);

                for (const c of categories) {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    categorySelect.appendChild(opt);
                }

                categorySelect.disabled = false;
                startBtn.disabled = rows.length === 0;
                resetBtn.disabled = false;

                updateStats();
            } catch (err) {
                categorySelect.innerHTML = `<option value="__error__">L·ªói t·∫£i d·ªØ li·ªáu</option>`;
                categorySelect.disabled = true;
                startBtn.disabled = true;
                resetBtn.disabled = false;

                // hi·ªÉn th·ªã l·ªói nh·∫π (kh√¥ng l·ªô stack)
                setFeedback("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c vocabulary.csv. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n v√† t√™n c·ªôt.", "bad");
                console.error(err);
            }
        }

        // ====== EVENTS ======
        startBtn.addEventListener("click", () => startQuiz());
        resetBtn.addEventListener("click", () => { resetAll(); });
        //doneResetBtn.addEventListener("click", () => { resetAll(); });

        submitBtn.addEventListener("click", handleSubmit);
        nextBtn.addEventListener("click", () => {
            if (!started) return;
            nextQuestion();
        });

        answerInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") handleSubmit();
        });

        // If toggles changed during quiz, rerender current question (kh√¥ng ƒë·ªïi ƒë√°p √°n)
        toggleImage.addEventListener("change", () => { if (started && queue.length) renderQuestion(); });
        toggleVn.addEventListener("change", () => { if (started && queue.length) renderQuestion(); });

        // init
        resetAll();
        loadData();
    </script>
</body>

</html>